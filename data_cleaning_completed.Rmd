---
title: "BST 260 Final Project"
author: "Binkai (Cathy) Liu, Karla Flores Guzman, Xinhui (Kiera) Zhang, Yichi Zhang, Jiabao (Lily) Zhong"
date: "11/18/2021"
output: html_document
---

Make sure the names of all group members are inside the RMarkdown file at the top

As this will be your only chance to describe your project in detail, make sure that your RMarkdown file and compiled HTML file are standalone documents that fully describe your process and results. 

Inside the RMarkdown file at the top, include instructions on where to access the data

## Overview and Motivation
Provide an overview of the project goals and the motivation for it. Consider that this will be read by people who did not see your project proposal

## Related Work
Anything that inspired you, such as a paper, a web site, or something we discussed in class.

## Initial Questions
What questions are you trying to answer? How did these questions evolve over the course of the project? What new questions did you consider in the course of your analysis?

## Data
Source, scraping method, cleanup, etc.

### Load packages
```{r load packages, message=FALSE, warning=FALSE}
library(tidyverse) 
library(readr)
library(dplyr)
library(rvest)
library(stringr)
library(readxl)
```

### Read in data sets & perform preliminary data wrangling

#### Predictor: GDP

* Data source:[Data source]()
* Data description:

```{r predictor GDP, warning=FALSE, message=FALSE}
# read in the data set
gdp_raw <- read_csv("rawdata_gdp.csv") # wide format

# convert to long format & remove NAs
gdp_long <- gdp_raw %>% gather(year, gdp, `1959`:`2019`) %>% drop_na()

# keep the most recent data
gdp_latest <- gdp_long %>% group_by(country) %>% slice_tail() %>% ungroup()

# convert "k" into thousand
gdp_latest <- gdp_latest %>%
  mutate(gdp = case_when(
    str_detect(gdp, "k") ~ as.numeric(str_extract(gdp, "[\\d\\.]+")) * 1000,
    TRUE ~ as.numeric(gdp)))

# change year column name
colnames(gdp_latest)[2]<-"gdp_latest_year"

# delete unwanted data sets
rm(gdp_raw); rm(gdp_long)
```

#### Predictor: Education level

* Data source:
* Data description:

```{r education level, message=FALSE}
# read in the data set
edu_raw <-read_csv("rawdata_edu_level.csv")

# convert to long format & remove NAs
edu_long <- edu_raw %>% 
  gather(year, years_in_school, `1969`:`2008`) %>%
  drop_na()

# keep the most recent data
edu_latest <- edu_long %>% group_by(country) %>% slice_tail()

# change year column name
colnames(edu_latest)[2]<-"edu_latest_year"

# delete unwanted data sets
rm(edu_raw); rm(edu_long)
```

#### Predictor: Geographic region

* Data source: 
* Data description:

```{r geographic region}
# code geographic regions & matched them with parent code in the UN data sets
geographic <- data.frame(region_s = c("Eastern Africa", "Middle Africa", 
                                      "Southern Africa", "Western Africa", 
                                      "Northern Africa", "Western Asia", 
                                      "Central Asia", "Southern Asia", 
                                      "Eastern Asia", "South-Eastern Asia", 
                                      "Caribbean", "Central America",
                                      "South America", 
                                      "Australia and New Zealand", "Melanesia",
                                      "Micronesia", "Polynesia", 
                                      "Eastern Europe", "Northern Europe",
                                      "Southern Europe", "Western Europe", 
                                      "Northern America"),
                         region_l = c(rep("Sub-saharan Africa", 4),
                                      rep("Northern Africa and Western Asia", 2),
                                      rep("Central and Southern Asia", 2),
                                      rep("Eastern and South-eastern Asia", 2),
                                      rep("Latin America and the Caribbean", 3),
                                      "Australia and New Zealand",
                                      rep("Other Oceania", 3),
                                      rep("Europe and Northern America", 5)),
                         code = c(910, 911, 913, 914, 912, 922, 5500, 5501, 906, 
                                  920, 915, 916, 931, 927, 928, 954, 957, 923, 
                                  924, 925, 926, 918))
```

#### Predictor: Contraceptive use

* Data source:
* Data description:

```{r contraceptives, message=FALSE}
# read in the data set
CM <- read_xlsx("rawdata_contraceptives.xlsx", 
                range = "By methods!A8:W1377", na = "..")

# set names
names(CM) <- as.character(c("country_area", "ISO", "start", "end", "age_group", 
                            CM[1, 6:23]))

# clean up variable names
names(CM) <- names(CM) %>%
  str_to_lower() %>%
  str_replace_all("[\\n]", "") %>% # remove "\n" in female/male sterilization
  str_replace_all("\\s\\(\\w+\\)$", "") %>% # remove " (LAM)"
  str_replace_all("[\\s\\/]", "_") # replace spaces with underscores

# remove first row with only column name information
CM <- CM[-1,] %>%  
  mutate_at(6:23, as.numeric) # change to numeric

# write a function to get the most recent usage% (after 2000) of a given method
most_recent <- function(var){ 
  CM %>%
    filter(end >= 2000) %>% drop_na(!!var) %>% group_by(country_area) %>% 
    slice(which.max(end)) %>% select(country_area, !!var)}
  # function input should be enclosed in quotes

# create a variable to store contraceptive methods
methods <- names(CM)[6:23] 

# create a new data frame; first column = 196 distinct country names
CM_2000 <- data.frame(country_area = levels(as.factor(CM$country_area)))

# loop over all contraceptive methods & use them as function input
for (method in methods){ 
  temp <- as.data.frame(most_recent(method)) 
  CM_2000 <- left_join(CM_2000, temp, by = "country_area")
    # append the outputs to CM_2000
  rm(temp)}

# collapse some categories of contraceptive methods into larger groups
CM_2000 <- CM_2000 %>% 
  mutate(invasive = rowSums(.[,c("female_sterilization", "male_sterilization", 
                                 "iud", "implant")], na.rm = TRUE),
         medication = rowSums(.[,c("injectable", "pill")], na.rm = TRUE),
         barrier = rowSums(.[,c("male_condom", "female_condom", 
                                "vaginal_barrier_methods")], na.rm = TRUE),
         other_modern = rowSums(.[,c("lactational_amenorrhea_method", 
                                     "emergency_contraception", 
                                     "other_modern_methods")], na.rm = TRUE),
         traditional = rowSums(.[,c("rhythm", "withdrawal", 
                                    "other_traditional_methods")], na.rm = TRUE))

# delete unwanted objects
rm(CM); rm(method); rm(methods); rm(most_recent)
```

#### Predictor: Mean age of childbearing

* Data source:
* Data description:

```{r mean age of childbearing}
# read in the data set
MAC <- read_xlsx("rawdata_mean_age_childbearing.xlsx", 
                 range = "ESTIMATES!C17:U272")

# data wrangling
MAC <- MAC %>% 
  select(`Region, subregion, country or area *`, `Parent code`, `2015-2020`) %>% 
  # keep relevant info
  setNames(c("country_area", "code", "mean_age_of_childbearing")) %>% 
  # rename: no spaces in names
  filter(code %in% geographic$code) %>% 
  # remove rows for world/regions/etc., keep country-level info
  select(-code) %>% 
  # remove variable "code"
  mutate(mean_age_of_childbearing = as.numeric(mean_age_of_childbearing)) 
  # change parameter to numeric
```

#### Predictor: Abortion law

* Data source:
* Data description:

```{r abortion law, warning = FALSE, message= FALSE}
# web scrap the abortion law table by country
url <- 'https://en.wikipedia.org/wiki/Abortion_law'
h <- read_html(url)
tab <- h %>% html_nodes("table") %>% .[6] %>% html_table %>% .[[1]] 

# remove rows that are subdivisions of a country
new_tab <- tab[-c(12:23, 38:40, 50:62, 148:179, 197:233, 299:302, 304:354),]
  # Australia (row 12-23); Bosnia and Herzegovina (row 38-40)
  # Canada (row 50-62); Mexico (row 148-179); Nigeria (row 197-233)
  # United kingdom (row 299-302); United states (row 304-354)
  # current rows = 212

# remove rows with "Country" in the country column (subtitle rows)
new_tab <- subset(new_tab, Country != "Country")
  # current rows = 202

# delete citation number of country name 
test <- gsub("(\\[).*", "", new_tab$Country) %>% str_trim(.)
clean_tab <- new_tab %>% mutate(Country = test)

# assign rigorous score of abortion law by country:
  # how many "prohibited" there are in each row (for each country)
score <- mutate(clean_tab, score = 
          str_count(clean_tab$`Risk to life`, "prohibited")
         +str_count(clean_tab$`Risk to health`, "prohibited")
         +str_count(clean_tab$Rape, "prohibited")
         +str_count(clean_tab$`Fetal impairment`, "prohibited")
         +str_count(clean_tab$`Economic or social`, "prohibited")
         +str_count(clean_tab$`On request`, "prohibited"))
score <- score %>% select(c("Country", "score"))
names(score) <- c("country", "score")

# delete unwanted data sets & vectors
rm(url); rm(h); rm(tab); rm(new_tab); rm(clean_tab); rm(test)
```

#### Outcomes: HIV incidence & prevalence

* Data source:
* Data description:

```{r HIV, message=FALSE}
#####################
####HIV incidence####
#####################

# read in the data set
HIV_new_raw<- read_csv("rawdata_HIV_incidence.csv")

# convert to long format & remove NAs
HIV_new_long <- HIV_new_raw %>%
  gather(year, HIV_new, `1989`:`2010`) %>%
  drop_na()

# keep the most recent data
HIV_new_latest <- HIV_new_long %>% group_by(country) %>% slice_tail()
  # all data comes after 2000

# change year column name
colnames(HIV_new_latest)[2]<-"HIV_new_latest_year"

# delete unwanted data sets
rm(HIV_new_raw); rm(HIV_new_long)

######################
####HIV prevalence####
######################

# read in the data set
HIV_prev_raw<- read_csv("rawdata_HIV_prevalence.csv")

# convert to long format & remove NAs
HIV_prev_long <- HIV_prev_raw %>%
  gather( year, HIV_prev, `1978`:`2010`) %>%
  drop_na()

# keep the most recent data
HIV_prev_latest <- HIV_prev_long %>% group_by(country) %>% slice_tail()
  # all data comes after 2000

# change year column name
colnames(HIV_prev_latest)[2]<-"HIV_prev_latest_year"

# delete unwanted data sets
rm(HIV_prev_raw); rm(HIV_prev_long)
```

#### Outcome: Syphilis rate

* Data source:
* Data description:

```{r syphilis, message=FALSE}
# read in the data set
syphi <- read_csv("rawdata_syphilis.csv")

# select the columns we want
syphi <- syphi %>% filter(IsLatestYear=="TRUE") %>% 
  select(`Location`,`Period`, `FactValueNumeric`)

# Solomon islands 2017 data might be typo in the original data set, 
  # so we manually input their 2015 data 
syphi$Period[which(syphi$Location=="Solomon Islands")] <- 2015
syphi$FactValueNumeric[which(syphi$Location=="Solomon Islands")] <- 13.2
```

#### Outcome: Infant mortality rate

* Data source:
* Data description:

```{r infant mortality rate, message=FALSE}
# read in the data set
infant <- read_csv("rawdata_infant_mortality.csv")

# select the columns we want
infant <- infant %>% 
  filter(IsLatestYear=="TRUE", Dim1 == "Both sexes") %>% 
  select(`Location`,`Period`, `FactValueNumeric`)
```

#### Outcome: Crude birth rate

* Data source:
* Data description:

```{r crude birth rate}
# read in the data set
BR <- read_xlsx("rawdata_birth_rate.xlsx", range = "ESTIMATES!C17:U272")

# data wrangling
BR <- BR %>% 
  select(`Region, subregion, country or area *`, `Parent code`, `2015-2020`) %>% 
  # keep relevant info
  setNames(c("country_area", "code", "crude_birth_rate_perK")) %>% 
  # rename: no spaces in names
  filter(code %in% geographic$code) %>% 
  # remove rows for world/regions/etc., keep country-level info
  full_join(geographic, by = "code") %>% 
  # add geographic region to the data set
  select(-code) %>% 
  # remove variable "code"
  mutate(crude_birth_rate_perK = as.numeric(crude_birth_rate_perK)) 
  # change parameter to numeric
```

### Join the data sets

```{r join the tables, warning=FALSE, message=FALSE}
#### combime data sets from the same source ####

# combine gapminder data sets
gapminder_predictors <- full_join(gdp_latest, edu_latest)
gapminder_outcomes <-full_join(HIV_new_latest, HIV_prev_latest) 
gapminder_full <- full_join(gapminder_predictors,gapminder_outcomes)

# combine UN data sets
CM_2000$country_area <- 
  str_replace_all(CM_2000$country_area, "Democratic People's Republic of Korea", 
                                       "Dem. People's Republic of Korea")
BR$country_area <- 
  str_replace_all(BR$country_area, "Czechia", "Czech Republic")
MAC$country_area <- 
  str_replace_all(MAC$country_area, "Czechia", "Czech Republic")

UNdata_BR_CM_MAC <- full_join(BR,CM_2000) %>% full_join(.,MAC)

# combine WHO data sets
colnames(infant)[3]<- "infant_mortality"
colnames(syphi)[3]<- "syphilis_rate"
WHOdata_infant_syphi <- left_join(infant,syphi, by="Location")
colnames(UNdata_BR_CM_MAC)[1] <- "country"
colnames(WHOdata_infant_syphi)[1] <- "country"


#### recode country names (reference: abortion law table) ####

# recode country names in gapminder data sets
country_key_gap = c(
  "Congo, Rep."="Congo",
  "Congo, Dem. Rep."="Democratic Republic of the Congo", 
  "Timor-Leste"="East Timor",
  "Cote d'Ivoire"="Ivory Coast",
  "Kyrgyz Republic"="Kyrgyzstan",
  "Lao"="Laos",
  "Micronesia, Fed. Sts."="Micronesia",
  "St. Kitts and Nevis"="Saint Kitts and Nevis",
  "St. Lucia"="Saint Lucia",
  "St. Vincent and the Grenadines"="Saint Vincent and the Grenadines",
  "Sao Tome and Principe"="São Tomé and Príncipe",
  "Slovak Republic"="Slovakia",
  "American Samoa"="Samoa",
  "Hong Kong, China"="China, Hong Kong SAR",
  "Macao, China"="China, Macao SAR",
  "Virgin Islands (U.S.)"="United States Virgin Islands")
gapminder_full <- gapminder_full %>% 
  mutate(country = recode_factor(country, !!!country_key_gap))

# recode country names in UN data sets
country_key_UN = c(
  "Bolivia (Plurinational State of)"="Bolivia",
  "Brunei Darussalam"="Brunei", 
  "Cabo Verde"="Cape Verde",
  "Timor-Leste"="East Timor",
  "Iran (Islamic Republic of)"="Iran",
  "Côte d'Ivoire"="Ivory Coast",
  "Lao People's Democratic Republic"="Laos",
  "Micronesia (Fed. States of)"="Micronesia",
  "Republic of Moldova"="Moldova",
  "Dem. People's Republic of Korea"="North Korea",
  "State of Palestine"="Palestine",
  "Russian Federation"="Russia",
  "Sao Tome and Principe"="São Tomé and Príncipe",
  "Republic of Korea"="South Korea",
  "Syrian Arab Republic"="Syria",
  "China, Taiwan Province of China"="Taiwan",
  "United Republic of Tanzania"="Tanzania",
  "United States of America"="United States",
  "Venezuela (Bolivarian Republic of)"="Venezuela",
  "Viet Nam"="Vietnam")
UNdata_BR_CM_MAC <- UNdata_BR_CM_MAC %>%   
  mutate(country = recode_factor(country, !!!country_key_UN))

# recode country names in WHO data sets
country_key_WHO = c(
  "Bolivia (Plurinational State of)"="Bolivia",
  "Brunei Darussalam"="Brunei", 
  "Cabo Verde"="Cape Verde",
  "Czechia"="Czech Republic",
  "Timor-Leste"="East Timor",
  "Iran (Islamic Republic of)"="Iran",
  "Côte d’Ivoire"="Ivory Coast",
  "Lao People's Democratic Republic"="Laos",
  "Micronesia (Federated States of)"="Micronesia",
  "Republic of Moldova"="Moldova",
  "Democratic People's Republic of Korea"="North Korea",
  "The former Yugoslav Republic of Macedonia"="North Macedonia",
  "Russian Federation"="Russia",
  "Sao Tome and Principe"="São Tomé and Príncipe",
  "Republic of Korea"="South Korea",
  "Syrian Arab Republic"="Syria",
  "United Republic of Tanzania"="Tanzania",
  "United Kingdom of Great Britain and Northern Ireland"="United Kingdom",
  "United States of America"="United States",
  "Venezuela (Bolivarian Republic of)"="Venezuela",
  "Viet Nam"="Vietnam")
WHOdata_infant_syphi <- WHOdata_infant_syphi %>%   
  mutate(country = recode_factor(country, !!!country_key_WHO))


#### combine all data sets ####
Score_GAP_UN_WHO <- full_join(score, gapminder_full) %>%
  full_join(., UNdata_BR_CM_MAC) %>%
  full_join(., WHOdata_infant_syphi)
world_clean <- Score_GAP_UN_WHO %>% 
  select(-gdp_latest_year, -edu_latest_year, -HIV_new_latest_year,
         -HIV_prev_latest_year, -Period.x,-Period.y)

#### remove temporary data sets ####
rm(list=setdiff(ls(), "world_clean"))

#### export data frame to csv ####
# write.csv(world_clean,"world_clean.csv", row.names = FALSE)
```

## Exploratory Analysis
What visualizations did you use to look at your data in different ways? What are the different statistical methods you considered? Justify the decisions you made, and show any major changes to your ideas. How did you reach these conclusions?
```{r}


data <- read.csv("world_clean.csv")

#Model 1-Linear model, outcome birth rate

lm_birth_rate <- lm(crude_birth_rate_perK ~ region_l + years_in_school + gdp +
                      score + any_method + mean_age_of_childbearing, data = data) #Create the linear regression
summary(lm_birth_rate) 

plot(lm_birth_rate$residuals, pch = 16, col = "red")


#Model 2-Linear model, outcome infant mortality rate

lm_infant_mortality <- lm(infant_mortality ~ region_l + years_in_school + gdp +
                      score + any_method + mean_age_of_childbearing, data = data) #Create the linear regression
summary(lm_infant_mortality) 

plot(lm_infant_mortality $residuals, pch = 16, col = "blue")


#Model 3-Linear model, outcome infant mortality rate

lm_syphilis <- lm(syphilis_rate ~ region_l + years_in_school + gdp +
                      score + any_method + mean_age_of_childbearing, data = data) #Create the linear regression
summary(lm_syphilis) 

plot(lm_syphilis$residuals, pch = 16, col = "green")












```

## Final Analysis
What did you learn about the data? How did you answer the questions? How can you justify your answers? Note that 1 type of analysis per team member is required. A Shiny app counts as a type of analysis.
```{r}





```

