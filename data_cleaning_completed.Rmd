---
title: "BST 260 Final Project"
author: "Binkai (Cathy) Liu, Karla Flores Guzman, Xinhui (Kiera) Zhang, Yichi Zhang, Jiabao (Lily) Zhong"
date: "11/18/2021"
output: html_document
---

Make sure the names of all group members are inside the RMarkdown file at the top

As this will be your only chance to describe your project in detail, make sure that your RMarkdown file and compiled HTML file are standalone documents that fully describe your process and results. 

Inside the RMarkdown file at the top, include instructions on where to access the data

## Overview and Motivation
Provide an overview of the project goals and the motivation for it. Consider that this will be read by people who did not see your project proposal

## Related Work
Anything that inspired you, such as a paper, a web site, or something we discussed in class.

## Initial Questions
What questions are you trying to answer? How did these questions evolve over the course of the project? What new questions did you consider in the course of your analysis?

## Data
Source, scraping method, cleanup, etc.

### Load packages
```{r load packages, message=FALSE, warning=FALSE}
library(tidyverse) 
library(readr)
library(dplyr)
library(rvest)
library(stringr)
library(readxl)
```

### Read in data sets & perform preliminary data wrangling

#### Predictor: GDP

* Data source:[Data source]()
* Data description:

```{r predictor GDP, warning=FALSE, message=FALSE}
# read in the data set
gdp_raw <- read_csv("rawdata_gdp.csv") # wide format

# convert to long format & remove NAs
gdp_long <- gdp_raw %>% gather(year, gdp, `1959`:`2019`) %>% drop_na()

# keep the most recent data
gdp_latest <- gdp_long %>% group_by(country) %>% slice_tail() %>% ungroup()

# convert "k" into thousand
gdp_latest <- gdp_latest %>%
  mutate(gdp = case_when(
    str_detect(gdp, "k") ~ as.numeric(str_extract(gdp, "[\\d\\.]+")) * 1000,
    TRUE ~ as.numeric(gdp)))

# change year column name
colnames(gdp_latest)[2]<-"gdp_latest_year"

# delete unwanted data sets
rm(gdp_raw); rm(gdp_long)
```

#### Predictor: Education level

* Data source:
* Data description:

```{r education level, message=FALSE}
# read in the data set
edu_raw <-read_csv("rawdata_edu_level.csv")

# convert to long format & remove NAs
edu_long <- edu_raw %>% 
  gather(year, years_in_school, `1969`:`2008`) %>%
  drop_na()

# keep the most recent data
edu_latest <- edu_long %>% group_by(country) %>% slice_tail()

# change year column name
colnames(edu_latest)[2]<-"edu_latest_year"

# delete unwanted data sets
rm(edu_raw); rm(edu_long)
```

#### Predictor: Geographic region

* Data source: 
* Data description:

```{r geographic region}
# code geographic regions & matched them with parent code in the UN data sets
geographic <- data.frame(region_l = c(rep("Sub-saharan Africa", 4),
                                      rep("Northern Africa and Western Asia", 2),
                                      rep("Central and Southern Asia", 2),
                                      rep("Eastern and South-eastern Asia", 2),
                                      rep("Latin America and the Caribbean", 3),
                                      "Australia and New Zealand",
                                      rep("Other Oceania", 3),
                                      rep("Europe and Northern America", 5)),
                         code = c(910, 911, 913, 914, 912, 922, 5500, 5501, 906, 
                                  920, 915, 916, 931, 927, 928, 954, 957, 923, 
                                  924, 925, 926, 918))

# dummy code region_l (categorical var.) 
regionL <- as.data.frame(dummy.code(geographic$region_l))

# rename the dummy coded variables & combine them with the original data set
regionL <- rename(regionL, r_Subsaharan_Africa = `Sub-saharan Africa`)
regionL <- rename(regionL, r_Euro_N.America = `Europe and Northern America`)
regionL <- rename(regionL, r_LatinAmerica = `Latin America and the Caribbean`)
regionL <- rename(regionL, r_NW.Africa = `Northern Africa and Western Asia`)
regionL <- rename(regionL, r_ESE.Asia = `Eastern and South-eastern Asia`)
regionL <- rename(regionL, r_CS.Asia = `Central and Southern Asia`)
regionL <- rename(regionL, r_OtherOceania = `Other Oceania`)
regionL <- rename(regionL, r_AU_NZ = `Australia and New Zealand`)
geographic <- cbind(geographic, regionL)
```

#### Predictor: Contraceptive use

* Data source:
* Data description:

```{r contraceptives, message=FALSE}
# read in the data set
CM <- read_xlsx("rawdata_contraceptives.xlsx", 
                range = "By methods!A8:W1377", na = "..")

# set names
names(CM) <- as.character(c("country_area", "ISO", "start", "end", "age_group", 
                            CM[1, 6:23]))

# clean up variable names
names(CM) <- names(CM) %>%
  str_to_lower() %>%
  str_replace_all("[\\n]", "") %>% # remove "\n" in female/male sterilization
  str_replace_all("\\s\\(\\w+\\)$", "") %>% # remove " (LAM)"
  str_replace_all("[\\s\\/]", "_") # replace spaces with underscores

# remove first row with only column name information
CM <- CM[-1,] %>%  
  mutate_at(6:23, as.numeric) # change to numeric

# write a function to get the most recent usage% (after 2000) of a given method
most_recent <- function(var){ 
  CM %>%
    filter(end >= 2000) %>% drop_na(!!var) %>% group_by(country_area) %>% 
    slice(which.max(end)) %>% dplyr::select(country_area, !!var)}
  # function input should be enclosed in quotes

# create a variable to store contraceptive methods
methods <- names(CM)[6:23] 

# create a new data frame; first column = 196 distinct country names
CM_2000 <- data.frame(country_area = levels(as.factor(CM$country_area)))

# loop over all contraceptive methods & use them as function input
for (method in methods){ 
  temp <- as.data.frame(most_recent(method)) 
  CM_2000 <- left_join(CM_2000, temp, by = "country_area")
    # append the outputs to CM_2000
  rm(temp)}

# collapse some categories of contraceptive methods into larger groups
CM_2000 <- CM_2000 %>% 
  mutate(invasive = rowSums(.[,c("female_sterilization", "male_sterilization", 
                                 "iud", "implant")], na.rm = T),
         medication = rowSums(.[,c("injectable", "pill")], na.rm = T),
         barrier = rowSums(.[,c("male_condom", "female_condom", 
                                "vaginal_barrier_methods")], na.rm = T),
         other_modern = rowSums(.[,c("lactational_amenorrhea_method", 
                                     "emergency_contraception", 
                                     "other_modern_methods")], na.rm = T),
         traditional = rowSums(.[,c("rhythm", "withdrawal", 
                                    "other_traditional_methods")], na.rm = T)) 

# remove unwanted columns
CM_2000 <- CM_2000 %>% 
  dplyr::select(c(country_area, any_method, any_modern_method,
                  any_traditional_method, invasive, medication, barrier, 
                  other_modern, traditional))

# delete unwanted objects
rm(CM); rm(method); rm(methods); rm(most_recent)
```

#### Predictor: Mean age of childbearing

* Data source:
* Data description:

```{r mean age of childbearing}
# read in the data set
MAC <- read_xlsx("rawdata_mean_age_childbearing.xlsx", 
                 range = "ESTIMATES!C17:U272")

# data wrangling
MAC <- MAC %>% 
  dplyr::select(`Region, subregion, country or area *`, `Parent code`, `2015-2020`) %>% 
  # keep relevant info
  setNames(c("country_area", "code", "mean_age_of_childbearing")) %>% 
  # rename: no spaces in names
  filter(code %in% geographic$code) %>% 
  # remove rows for world/regions/etc., keep country-level info
  dplyr::select(-code) %>% 
  # remove variable "code"
  mutate(mean_age_of_childbearing = as.numeric(mean_age_of_childbearing))
```

#### Predictor: Abortion law

* Data source:
* Data description:

```{r abortion law, warning = FALSE, message= FALSE}
# web scrap the abortion law table by country
url <- 'https://en.wikipedia.org/wiki/Abortion_law'
h <- read_html(url)
tab <- h %>% html_nodes("table") %>% .[6] %>% html_table %>% .[[1]] 

# remove rows that are subdivisions of a country
new_tab <- tab[-c(12:23, 38:40, 50:62, 148:179, 197:233, 299:302, 304:354),]
  # Australia (row 12-23); Bosnia and Herzegovina (row 38-40)
  # Canada (row 50-62); Mexico (row 148-179); Nigeria (row 197-233)
  # United kingdom (row 299-302); United states (row 304-354)
  # current rows = 212

# remove rows with "Country" in the country column (subtitle rows)
new_tab <- subset(new_tab, Country != "Country")
  # current rows = 202

# delete citation number of country name 
test <- gsub("(\\[).*", "", new_tab$Country) %>% str_trim(.)
clean_tab <- new_tab %>% mutate(Country = test)

# assign rigorous score of abortion law by country:
  # how many "prohibited" there are in each row (for each country)
score <- mutate(clean_tab, score = 
          str_count(clean_tab$`Risk to life`, "prohibited")
         +str_count(clean_tab$`Risk to health`, "prohibited")
         +str_count(clean_tab$Rape, "prohibited")
         +str_count(clean_tab$`Fetal impairment`, "prohibited")
         +str_count(clean_tab$`Economic or social`, "prohibited")
         +str_count(clean_tab$`On request`, "prohibited"))
score <- score %>% dplyr::select(c("Country", "score"))
names(score) <- c("country", "score")

# delete unwanted data sets & vectors
rm(url); rm(h); rm(tab); rm(new_tab); rm(clean_tab); rm(test)
```

#### Outcome: HIV prevalence

* Data source:
* Data description:

```{r HIV, message=FALSE}
# read in the data set
HIV_prev_raw<- read_csv("rawdata_HIV_prevalence.csv")

# convert to long format & remove NAs
HIV_prev_long <- HIV_prev_raw %>%
  gather( year, HIV_prev, `1978`:`2010`) %>%
  drop_na()

# keep the most recent data
HIV_prev_latest <- HIV_prev_long %>% group_by(country) %>% slice_tail()
  # all data comes after 2000

# change year column name
colnames(HIV_prev_latest)[2]<-"HIV_prev_latest_year"

# delete unwanted data sets
rm(HIV_prev_raw); rm(HIV_prev_long)
```

#### Outcome: Infant mortality rate

* Data source:
* Data description:

```{r infant mortality rate, message=FALSE}
# read in the data set
infant <- read_csv("rawdata_infant_mortality.csv")

# select the columns we want
infant <- infant %>% 
  filter(IsLatestYear=="TRUE", Dim1 == "Both sexes") %>% 
  dplyr::select(`Location`,`Period`, `FactValueNumeric`)
```

#### Outcome: Crude birth rate

* Data source:
* Data description:

```{r crude birth rate}
# read in the data set
BR <- read_xlsx("rawdata_birth_rate.xlsx", range = "ESTIMATES!C17:U272")

# data wrangling
BR <- BR %>% 
  dplyr::select(`Region, subregion, country or area *`, `Parent code`, `2015-2020`) %>% 
  # keep relevant info
  setNames(c("country_area", "code", "crude_birth_rate_perK")) %>% 
  # rename: no spaces in names
  filter(code %in% geographic$code) %>% 
  # remove rows for world/regions/etc., keep country-level info
  full_join(geographic, by = "code") %>% 
  # add geographic region to the data set
  dplyr::select(-code) %>% 
  # remove variable "code"
  mutate(crude_birth_rate_perK = as.numeric(crude_birth_rate_perK)) 
  # change parameter to numeric
```

### Join the tables & Final clean-up

```{r join the tables, warning=FALSE, message=FALSE}
#### combime data sets from the same source ####

# combine gapminder data sets
gapminder_predictors <- full_join(gdp_latest, edu_latest)
gapminder_full <- full_join(gapminder_predictors, HIV_prev_latest)

# combine UN data sets
CM_2000$country_area <- 
  str_replace_all(CM_2000$country_area, "Democratic People's Republic of Korea",
                  "Dem. People's Republic of Korea")
BR$country_area <- 
  str_replace_all(BR$country_area, "Czechia", "Czech Republic")
MAC$country_area <- 
  str_replace_all(MAC$country_area, "Czechia", "Czech Republic")

UNdata_BR_CM_MAC <- full_join(BR,CM_2000) %>% full_join(.,MAC)
colnames(UNdata_BR_CM_MAC)[1] <- "country"

# combine WHO data sets
colnames(infant)[3]<- "infant_mortality"
WHOdata_infant <- infant
colnames(WHOdata_infant)[1] <- "country"


#### recode country names (reference: abortion law table) ####

# recode country names in gapminder data sets
country_key_gap = c(
  "Congo, Rep."="Congo",
  "Congo, Dem. Rep."="Democratic Republic of the Congo", 
  "Timor-Leste"="East Timor",
  "Cote d'Ivoire"="Ivory Coast",
  "Kyrgyz Republic"="Kyrgyzstan",
  "Lao"="Laos",
  "Micronesia, Fed. Sts."="Micronesia",
  "St. Kitts and Nevis"="Saint Kitts and Nevis",
  "St. Lucia"="Saint Lucia",
  "St. Vincent and the Grenadines"="Saint Vincent and the Grenadines",
  "Sao Tome and Principe"="São Tomé and Príncipe",
  "Slovak Republic"="Slovakia",
  "American Samoa"="Samoa",
  "Hong Kong, China"="China, Hong Kong SAR",
  "Macao, China"="China, Macao SAR",
  "Virgin Islands (U.S.)"="United States Virgin Islands")
gapminder_full <- gapminder_full %>% 
  mutate(country = recode_factor(country, !!!country_key_gap))

# recode country names in UN data sets
country_key_UN = c(
  "Bolivia (Plurinational State of)"="Bolivia",
  "Brunei Darussalam"="Brunei", 
  "Cabo Verde"="Cape Verde",
  "Timor-Leste"="East Timor",
  "Iran (Islamic Republic of)"="Iran",
  "Côte d'Ivoire"="Ivory Coast",
  "Lao People's Democratic Republic"="Laos",
  "Micronesia (Fed. States of)"="Micronesia",
  "Republic of Moldova"="Moldova",
  "Dem. People's Republic of Korea"="North Korea",
  "State of Palestine"="Palestine",
  "Russian Federation"="Russia",
  "Sao Tome and Principe"="São Tomé and Príncipe",
  "Republic of Korea"="South Korea",
  "Syrian Arab Republic"="Syria",
  "China, Taiwan Province of China"="Taiwan",
  "United Republic of Tanzania"="Tanzania",
  "United States of America"="United States",
  "Venezuela (Bolivarian Republic of)"="Venezuela",
  "Viet Nam"="Vietnam")
UNdata_BR_CM_MAC <- UNdata_BR_CM_MAC %>%   
  mutate(country = recode_factor(country, !!!country_key_UN))

# recode country names in WHO data sets
country_key_WHO = c(
  "Bolivia (Plurinational State of)"="Bolivia",
  "Brunei Darussalam"="Brunei", 
  "Cabo Verde"="Cape Verde",
  "Czechia"="Czech Republic",
  "Timor-Leste"="East Timor",
  "Iran (Islamic Republic of)"="Iran",
  "Côte d’Ivoire"="Ivory Coast",
  "Lao People's Democratic Republic"="Laos",
  "Micronesia (Federated States of)"="Micronesia",
  "Republic of Moldova"="Moldova",
  "Democratic People's Republic of Korea"="North Korea",
  "The former Yugoslav Republic of Macedonia"="North Macedonia",
  "Russian Federation"="Russia",
  "Sao Tome and Principe"="São Tomé and Príncipe",
  "Republic of Korea"="South Korea",
  "Syrian Arab Republic"="Syria",
  "United Republic of Tanzania"="Tanzania",
  "United Kingdom of Great Britain and Northern Ireland"="United Kingdom",
  "United States of America"="United States",
  "Venezuela (Bolivarian Republic of)"="Venezuela",
  "Viet Nam"="Vietnam")
WHOdata_infant <- WHOdata_infant %>%   
  mutate(country = recode_factor(country, !!!country_key_WHO))


#### combine all data sets ####
Score_GAP_UN_WHO <- full_join(score, gapminder_full) %>%
  full_join(., UNdata_BR_CM_MAC) %>%
  full_join(., WHOdata_infant)
world_clean <- Score_GAP_UN_WHO %>% 
  dplyr::select(-gdp_latest_year, -edu_latest_year, 
         -HIV_prev_latest_year, -Period)

####  remove temporary data sets #### 
rm(list=setdiff(ls(), "world_clean"))

#### export data frame to csv ####
write.csv(world_clean,"world_clean.csv", row.names = FALSE)
```










## Exploratory Analysis
What visualizations did you use to look at your data in different ways? What are the different statistical methods you considered? Justify the decisions you made, and show any major changes to your ideas. How did you reach these conclusions?

First Model: Prediction of outcome of Birth rate

We are trying to predict the birth rate in a country using socioeconomic features and controlling by region.
Main variables we are using are:
  -Years in school:  Level of education is a proxy to understand if women were able to receive sexual education
  - Gross domestic product: The income of a region can help us to predict if the population has good medical coverage and access to information of family planning
  - Use of a contraceptive method: Contraceptive methods hinder unplanned childbirth 
  - Mean age of childbearing: the sooner a woman starts having children will increase the expected children that can have (also, it is important to keep in mind that this variable can have an endogenous bias)
  - Region: Childbirth might change by region regardless of other socioeconomic variables
  - Score: We have an estimated score based on abortion legality

Exploratory data analysis: 

i. Linear association with the outcome: We will measure the association of each variable by itself with the outcome we want to predict and also analyze the residual
ii.Correlation Matrix: We want to see how our variables correlate between themselves.


i.a Association of outcome with years of School
*We can appreciate a statistically significant negative association, which is bolstering our hypothesis.Also, the residual errors do not show a pattern that might alert us of any bias.*

```{r}
data <- read.csv("world_clean.csv")

lm_birth_rate_predicted_by_years_in_school <- lm(crude_birth_rate_perK ~  years_in_school , data = data) 
summary(lm_birth_rate_predicted_by_years_in_school) 
plot(lm_birth_rate_predicted_by_years_in_school$residuals, pch = 16, col = "red")
```

  

i.b Association of outcome with wealth of the nation (gdp per capita)
*We also can appreciate a statistically significant negative association, which is bolstering our hypothesis that Women with a better income have access to better medical attention and family planning.But also, the effect is very small compared with education (-3.e-4 vs -2, v.gr. 10,000 smaller). Additionally, the residual errors do not show a pattern that might alert us of any bias.*

```{r}
lm_birth_rate_predicted_by_gdp <- lm(crude_birth_rate_perK ~  gdp , data = data) 
summary(lm_birth_rate_predicted_by_gdp) 
plot(lm_birth_rate_predicted_by_gdp$residuals, pch = 16, col = "violet")
```

i.c Association of outcome with the use of contraceptive methods
*We also can appreciate a statistically significant negative association and see that the effect is higher than gdp but lower than education and could be related with the fact that the use of a contraceptive method does not guarantee unplanned children if it is not used in a right way but a higher level of education will imply an effective use (let's see how those 2 variables correlate in the correlation matrix). Also, the residual errors do not show a pattern that might alert us of any bias.*

```{r}
lm_birth_rate_predicted_by_any_method <- lm(crude_birth_rate_perK ~  any_method , data = data) 
summary(lm_birth_rate_predicted_by_any_method) 
plot(lm_birth_rate_predicted_by_any_method$residuals, pch = 16, col = "green")
```
i.d Association of outcome with mean age of childbearing
*We see a negative association, which makes sense as the older a woman start having children, it is less probable that she will have many kids, but the association is not as robust as the previous variables. Also, the residuals seem to be loaded to low values (it is not uniform as it should be). Let's use this variable with precautions because it can have endogenity.*

```{r}
lm_birth_rate_predicted_by_mean_age_of_childbearing <- lm(crude_birth_rate_perK ~  mean_age_of_childbearing , data = data) 
summary(lm_birth_rate_predicted_by_mean_age_of_childbearing) 
plot(lm_birth_rate_predicted_by_mean_age_of_childbearing$residuals, pch = 16, col = "red")
```

i.e Association of outcome with abortion legality score
*The abortion legality score is statistically positive. Notwithstanding, the residuals do not look uniform so we should use this variable with caution.*

```{r}
lm_birth_rate_predicted_by_score <- lm(crude_birth_rate_perK ~  score , data = data) 
summary(lm_birth_rate_predicted_by_score) 
plot(lm_birth_rate_predicted_by_score$residuals, pch = 16, col = "brown")
```
i.f Association of outcome with region
*Regions have different effects on child birth. But for some cases the effect is not statistically significant. Because of this. It is sensible to use a dummy for those regions where the effect is robust such as: region_lSub-saharan Africa,region_lCentral and Southern Asia, region_lOther Oceania.*

```{r}
lm_birth_rate_predicted_by_regionL <- lm(crude_birth_rate_perK ~  region_l , data = data) 
summary(lm_birth_rate_predicted_by_regionL) 
plot(lm_birth_rate_predicted_by_regionL$residuals, pch = 16, col = "cyan")
```

```{r}
lm_birth_rate_predicted_by_regionL <- lm(crude_birth_rate_perK ~  r_Subsaharan_Africa+ r_OtherOceania  + r_CS.Asia , data = data) 
summary(lm_birth_rate_predicted_by_regionL) 
plot(lm_birth_rate_predicted_by_regionL$residuals, pch = 16, col = "purple")
```


ii. Matrix correlation

*After estimating the correlation matrix of all numeric variables (we are excluding the regions), the variable any_method is highly correlated with years of education, gdp and score, but let's see how the features interact in the model.*

```{r}
linear_model_variables <-data%>% select(mean_age_of_childbearing,any_method,gdp,years_in_school,score)

NA2mean <- function(x) replace(x, is.na(x), mean(x, na.rm = TRUE))

replaced_nulls <- replace(linear_model_variables, TRUE, lapply(linear_model_variables, NA2mean))
cor(replaced_nulls)

```

## Using all features for the model
gdp and mean_age_of_childbearing are not statistically signifficant. Let's remove them

```{r}
lm_birth_rate_all_features <- lm(crude_birth_rate_perK ~   r_Subsaharan_Africa+ r_OtherOceania  + r_CS.Asia+ mean_age_of_childbearing+any_method+gdp+years_in_school+score, data = data) 
summary(lm_birth_rate_all_features) 
plot(lm_birth_rate_all_features$residuals, pch = 16, col = "pink")

```

## After dropping  gdp and mean_age_of_childbearing
We have all features as statically significant.

```{r}
lm_birth_rate_all_features <- lm(crude_birth_rate_perK ~   r_Subsaharan_Africa+ r_OtherOceania  + r_CS.Asia+ any_method+years_in_school+score, data = data) 
summary(lm_birth_rate_all_features) 
plot(lm_birth_rate_all_features$residuals, pch = 16, col = "purple")

```


Second Model: Prediction of outcome of Infant Mortality rate

We are trying to predict the infant mortality rate in a country using socioeconomic features and controlling by region.
Main variables we are using are:
  - Years in school:  Level of education might indicate better knowledge of how a parents have to take care of children.
  - Gross domestic product: The income of a region can help us to predict if the population has good medical coverage.
  - Use of a contraceptive method: Contraceptive methods enhance family planning and better attention to children.
  - Mean age of childbearing: the sooner a woman starts having children the least is prepared to be a sensible mother.
  - Region: Region can consider other socioeconomic variables not reflected on previous ones.
  - Score: We have an estimated score based on abortion legality which is correlated with unplanned parenthood.

Exploratory data analysis: 

i. Linear association with the outcome: We will measure the association of each variable by itself with the outcome we want to predict and also analyze the residual
ii.Correlation Matrix: We already did this analysis for child birth.


i.a Association of outcome with years of School
*The results are robust sustaining the hypothesis that more years of school strongly hinder child mortality and we do not see patterns on the residuals.*

```{r}
lm_infant_mortality_predicted_by_years_in_school <- lm(infant_mortality ~  years_in_school , data = data) 
summary(lm_infant_mortality_predicted_by_years_in_school) 
plot(lm_infant_mortality_predicted_by_years_in_school$residuals, pch = 16, col = "red")
```

  

i.b Association of outcome with wealth of the nation (gdp per capita)
*The results are also robust sustaining the hypothesis that a better income hinders child mortality but the effect is very low (-4e-4) and we do not see patterns on the residuals.*

```{r}
lm_infant_mortality_predicted_by_gdp <- lm(infant_mortality ~  gdp , data = data) 
summary(lm_infant_mortality_predicted_by_gdp) 
plot(lm_infant_mortality_predicted_by_gdp$residuals, pch = 16, col = "violet")
```

i.c Association of outcome with the use of contraceptive methods
*The results are also robust sustaining the hypothesis that using contraceptive methods hinders child mortality because parents will have planned children and we do not see patterns on the residuals.*


```{r}
lm_infant_mortality_predicted_by_any_method <- lm(infant_mortality ~  any_method , data = data) 
summary(lm_infant_mortality_predicted_by_any_method) 
plot(lm_infant_mortality_predicted_by_any_method$residuals, pch = 16, col = "green")
```
i.d Association of outcome with mean age of childbearing
*We see a negative effect but it is not statistically signifficant. Also, residuals are negativelly loaded (we should not blindly trust on using it).*

```{r}
lm_infant_mortality_predicted_by_mean_age_of_childbearing <- lm(infant_mortality ~  mean_age_of_childbearing , data = data) 
summary(lm_infant_mortality_predicted_by_mean_age_of_childbearing) 
plot(lm_infant_mortality_predicted_by_mean_age_of_childbearing$residuals, pch = 16, col = "red")
```

i.e Association of outcome with abortion legality score
*The abortion legality score is statistically positive.*

```{r}
lm_infant_mortality_predicted_by_score <- lm(infant_mortality ~  score , data = data) 
summary(lm_infant_mortality_predicted_by_score) 
plot(lm_infant_mortality_predicted_by_score$residuals, pch = 16, col = "cyan")
```
i.f Association of outcome with region
*Regions have different effects on child mortality. But for some cases the effect is not statistically significant. Because of this. It is sensible to use a dummy for those regions where the effect is robust such as: region_lSub-saharan Africa,region_lCentral and Southern Asia, region_lOther Oceania (the same ones we chose for child birth rate but only Subsaharian Africa is strongly robust.).*

```{r}
lm_infant_mortality_predicted_by_regionL <- lm(infant_mortality ~  region_l , data = data) 
summary(lm_infant_mortality_predicted_by_regionL) 
plot(lm_infant_mortality_predicted_by_regionL$residuals, pch = 16, col = "purple")
```

```{r}
lm_infant_mortality_predicted_by_regionL <- lm(infant_mortality ~  r_Subsaharan_Africa+ r_OtherOceania  + r_CS.Asia , data = data) 
summary(lm_infant_mortality_predicted_by_regionL) 
plot(lm_infant_mortality_predicted_by_regionL$residuals, pch = 16, col = "purple")
```

## Using all features for the model
gdp is not statistically significant. Let's remove it first before removing the other ones that also are not significant

```{r}
lm_infant_mortality_all_features <- lm(infant_mortality ~   r_Subsaharan_Africa+ r_OtherOceania  + r_CS.Asia+ mean_age_of_childbearing+any_method+gdp+years_in_school+score, data = data) 
summary(lm_infant_mortality_all_features) 
plot(lm_infant_mortality_all_features$residuals, pch = 16, col = "purple")

```

## After dropping  gdp
Dummy regions of Oceania and CS Asia are not statistically sifnificant, let's drop them.

```{r}
lm_infant_mortality_selected_features_1 <- lm(infant_mortality ~   r_Subsaharan_Africa+ r_OtherOceania  + r_CS.Asia+ mean_age_of_childbearing+any_method+years_in_school+score, data = data) 
summary(lm_infant_mortality_selected_features_1) 
plot(lm_infant_mortality_selected_features_1$residuals, pch = 16, col = "purple")

```
## After dropping  Oceania and CS Asia
Abortion legality score remains as non-relevant. Let's remove it from the last model

```{r}
lm_infant_mortality_selected_features_2 <- lm(infant_mortality ~   r_Subsaharan_Africa+  mean_age_of_childbearing+any_method+years_in_school+score, data = data) 
summary(lm_infant_mortality_selected_features_2) 
plot(lm_infant_mortality_selected_features_2$residuals, pch = 16, col = "purple")

```
## After dropping  Abortion Law Score
Years in school, mean age of childbearing anduse of contraceptive methods reduce infant mortality and being in a country from Subsaharan Africa increases it drastically.

```{r}
lm_infant_mortality_selected_features_3 <- lm(infant_mortality ~   r_Subsaharan_Africa+  mean_age_of_childbearing+any_method+years_in_school, data = data) 
summary(lm_infant_mortality_selected_features_3) 
plot(lm_infant_mortality_selected_features_3$residuals, pch = 16, col = "purple")

```



Third Model: Prediction of outcome of HIV prevalence

We are trying to predict the HIV prevalence in a country using socioeconomic features and controlling by region.
Main variables we are using are:
  - Years in school:  Level of education might indicate better knowledge of how how to prevent STDs (including HIV).
  - Gross domestic product: The income of a region can help us to predict has access to condoms and information.
  - Use of a contraceptive method: Contraceptive methods imply better sexual health practices.
  - Barrier: Barrier method has a high risk reduction of contracting HIV. 
  - Region: Region can consider other socioeconomic variables not reflected on previous ones.
  - Score: We have an estimated score based on abortion legality which is correlated with unplanned parenthood.

Exploratory data analysis: 

i. Linear association with the outcome: We will measure the association of each variable by itself with the outcome we want to predict and also analyze the residual
ii.Correlation Matrix: Let's see how variables correlate by themselves.

Note: As HIV prevalence is not reported by all countries, let's see how many countries have a null value

```{r}
sum(is.na(data$HIV_prev))
```

*77 Countries did not report HIV prevalence. Given this, let's use only countries reporting it and be aware that reporting might play as a bias.*
```{r}
data_2 <-data%>%filter(HIV_prev>-1) 
data_2
```
i.a Association of outcome with years of School
*Years in School does not seem to impact HIV prevalence by itself. Also, residuals are highly loaded to a negative value (let's be aware of using it to predict HIV prevalence).*

```{r}
lm_HIV_prev_predicted_by_years_in_school <- lm(HIV_prev ~  years_in_school , data = data) 
summary(lm_HIV_prev_predicted_by_years_in_school) 
plot(lm_HIV_prev_predicted_by_years_in_school$residuals, pch = 16, col = "red")
```


i.b Association of outcome with wealth of the nation (gdp per capita)
*GDP shows a negative impact but the impact is not robust. Also, we see that residuals are far from being uniform.*

```{r}
lm_HIV_prev_predicted_by_gdp <- lm(HIV_prev ~  gdp , data = data_2) 
summary(lm_HIV_prev_predicted_by_gdp) 
plot(lm_HIV_prev_predicted_by_gdp$residuals, pch = 16, col = "violet")
```

i.c Association of outcome with the use of contraceptive methods
*Any method not seem to impact HIV prevalence by itself. Also, residuals are highly loaded to a negative value. It seems that the HIV prevalence might have an error*


```{r}
lm_HIV_prev_predicted_by_any_method <- lm(HIV_prev ~  any_method , data = data_2) 
summary(lm_HIV_prev_predicted_by_any_method) 
plot(lm_HIV_prev_predicted_by_any_method$residuals, pch = 16, col = "green")
```
i.d Association of outcome with barrier
*Residuals remain as not uniform and the effect is not robust*

```{r}
lm_HIV_prev_predicted_by_barrier <- lm(HIV_prev ~  barrier , data = data_2) 
summary(lm_HIV_prev_predicted_by_barrier) 
plot(lm_HIV_prev_predicted_by_barrier$residuals, pch = 16, col = "red")
```

i.e Association of outcome with abortion legality score
*Residuals remain as not uniform and the effect is not robust*

```{r}
lm_HIV_prev_predicted_by_score <- lm(HIV_prev ~  score , data = data_2) 
summary(lm_HIV_prev_predicted_by_score) 
plot(lm_HIV_prev_predicted_by_score$residuals, pch = 16, col = "purple")
```
i.f Association of outcome with region
*Not a single region explains HIV prevalence.*

```{r}
lm_HIV_prev_predicted_by_regionL <- lm(HIV_prev ~  region_l , data = data_2) 
summary(lm_HIV_prev_predicted_by_regionL) 
plot(lm_HIV_prev_predicted_by_regionL$residuals, pch = 16, col = "purple")
```

## Red flag
*Not a single variable explains HIV prevalence which is counterintuitive and is a strong signal that the data might be wrong.*

```{r}
lm_HIV_prev_all_features <- lm(HIV_prev ~    barrier+any_method+gdp+years_in_school+score, data = data) 
summary(lm_HIV_prev_all_features) 
plot(lm_HIV_prev_all_features$residuals, pch = 16, col = "purple")

```

```{r}
lm_HIV_prev_all_features <- lm(HIV_prev ~    barrier+gdp+years_in_school, data = data) 
summary(lm_HIV_prev_all_features) 
plot(lm_HIV_prev_all_features$residuals, pch = 16, col = "purple")

```
```{r}
lm_HIV_prev_all_features <- lm(HIV_prev ~    barrier+gdp, data = data) 
summary(lm_HIV_prev_all_features) 
plot(lm_HIV_prev_all_features$residuals, pch = 16, col = "purple")

```



## Final Analysis
What did you learn about the data? How did you answer the questions? How can you justify your answers? Note that 1 type of analysis per team member is required. A Shiny app counts as a type of analysis.
```{r}





```

