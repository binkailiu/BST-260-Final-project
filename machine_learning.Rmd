---
title: "Models"
date: "12/8/2021"
output: html_document
---

### Load packages & Read in the cleaned data set
```{r load packages}
library(tidyverse)
library(readr)
library(caret)
library(tree)
library(MASS)
library(rpart)
library(rpart.plot)
library(psych)
library(FNN)

world_clean <- read_csv("world_clean.csv")
```

### Linear Regression for All Three Outcomes

```{r}
#### Birth rate ####
lm_birth_rate <- 
  lm(crude_birth_rate_perK ~ region_l + years_in_school + gdp + score + 
       any_method + mean_age_of_childbearing, data = world_clean) 
summary(lm_birth_rate) 
plot(lm_birth_rate$residuals, pch = 16, col = "red")

#### Prediction

#### Calibration plot

#### Pearson coefficients



#### Infant mortality rate ####
lm_infant_mortality <- 
  lm(infant_mortality ~ region_l + years_in_school + gdp + score + any_method + 
       mean_age_of_childbearing, data = world_clean) 
summary(lm_infant_mortality) 
plot(lm_infant_mortality $residuals, pch = 16, col = "blue")

#### Prediction

#### Calibration plot

#### Pearson coefficients



#### Syphilis positive rate ####
lm_syphilis <- 
  lm(syphilis_rate ~ region_l + years_in_school + gdp + score + any_method, 
     data = world_clean) 
summary(lm_syphilis) 
plot(lm_syphilis$residuals, pch = 16, col = "green")
lm_syphilis_pred <- predict(lm_syphilis)

#### Prediction

#### Calibration plot

#### Pearson coefficients



```


### Decision Trees for Birth Rate and Infant Mortality Rate

#### Create training and testing datasets for decision trees
```{r split data sets - decision tree}
set.seed(260)

# remove countries with no outcome data available
BR.NoNA <- world_clean %>% drop_na(crude_birth_rate_perK)
IM.NoNA <- world_clean %>% drop_na(infant_mortality)

# create indices for training set (training:testing = 7:3)
BR.index.train <- 
  createDataPartition(y = BR.NoNA$crude_birth_rate_perK, p = 0.7, list = FALSE)
IM.index.train <- 
  createDataPartition(y = IM.NoNA$infant_mortality, p = 0.7, list = FALSE)

# split the data sets
BR.train <- slice(BR.NoNA, BR.index.train) # 142 rows
BR.test <- slice(BR.NoNA, -BR.index.train) # 60 rows
IM.train <- slice(IM.NoNA, IM.index.train) # 138 rows
IM.test <- slice(IM.NoNA, -IM.index.train) # 57 rows

# delete unwanted objects
rm(BR.NoNA); rm(IM.NoNA); rm(BR.index.train); rm(IM.index.train)
```


#### Run decision trees
```{r}
#### Birth rate ####

# fit the model
BR.rpart <- rpart(crude_birth_rate_perK ~ factor(region_l) + years_in_school + 
                  gdp + score + any_method + mean_age_of_childbearing, 
                  data = BR.train)

# prune the tree
BR.min.cp = BR.rpart$cptable[which.min(BR.rpart$cptable[,"xerror"]),"CP"]
BR.pruned <- prune(BR.rpart, cp = BR.min.cp) 

# plot the tree
rpart.plot(BR.pruned, digits = 4)

# calculate MSEs
BR.pred.rpart.train <- predict(BR.rpart, newdata = BR.train)
mean((BR.pred.rpart.train - BR.train$crude_birth_rate_perK)^2) # 15.05798
BR.pred.rpart.test <- predict(BR.rpart, newdata = BR.test)
mean((BR.pred.rpart.test - BR.test$crude_birth_rate_perK)^2) # 28.80571

# calculate Pearson coefficients
cor.test(BR.pred.rpart.train, BR.train$crude_birth_rate_perK,
          method="pearson", conf.level=0.95) # 0.9186833 
cor.test(BR.pred.rpart.test, BR.test$crude_birth_rate_perK,
          method="pearson", conf.level=0.95) # 0.8290002 



#### Infant mortality rate ####

# fit the model
IM.rpart <- rpart(infant_mortality ~ factor(region_l) + years_in_school + 
                  gdp + score +  any_method + mean_age_of_childbearing, 
                  data = IM.train)

# prune the tree
IM.min.cp = IM.rpart$cptable[which.min(IM.rpart$cptable[,"xerror"]),"CP"]
IM.pruned <- prune(IM.rpart, cp = IM.min.cp) 

# plot the tree
rpart.plot(IM.pruned, digits = 4)

# calculate MSEs
IM.pred.rpart.train = predict(IM.rpart, newdata = IM.train)
mean((IM.pred.rpart.train - IM.train$infant_mortality)^2) # 82.34768
IM.pred.rpart.test = predict(IM.rpart, newdata = IM.test)
mean((IM.pred.rpart.test - IM.test$infant_mortality)^2) # 101.4127

# calculate Pearson coefficients
cor.test(IM.pred.rpart.train, IM.train$infant_mortality,
          method="pearson", conf.level=0.95) # 0.8841798 
cor.test(IM.pred.rpart.test, IM.test$infant_mortality,
          method="pearson", conf.level=0.95) # 0.8680682
```

### KNN regression for Birth Rate and Infant Mortality Rate

#### Dummy-code categorical var. & Scale continuous var. for KNN regression
```{r}
# dummy code region_l (categorical var.) for KNN regression
regionL <- as.data.frame(dummy.code(world_clean$region_l))

# rename the dummy coded variables and combine them with the original data set
regionL <- rename(regionL, r_Subsaharan_Africa = `Sub-saharan Africa`)
regionL <- rename(regionL, r_Euro_N.America = `Europe and Northern America`)
regionL <- rename(regionL, r_LatinAmerica = `Latin America and the Caribbean`)
regionL <- rename(regionL, r_NW.Africa = `Northern Africa and Western Asia`)
regionL <- rename(regionL, r_ESE.Asia = `Eastern and South-eastern Asia`)
regionL <- rename(regionL, r_CS.Asia = `Central and Southern Asia`)
regionL <- rename(regionL, r_OtherOceania = `Other Oceania`)
regionL <- rename(regionL, r_AU_NZ = `Australia and New Zealand`)
knn_dataset <- 
  cbind(world_clean[, c("country", "crude_birth_rate_perK", "infant_mortality", 
                        "years_in_school", "gdp", "score", "any_method", 
                        "mean_age_of_childbearing")], regionL)

# scale the continuous variables
knn_dataset[, c("years_in_school", "gdp", "score", "any_method", "mean_age_of_childbearing")] <- scale(world_clean[, c("years_in_school", "gdp", "score", "any_method", "mean_age_of_childbearing")])
```

#### Create training and testing datasets for KNN regression
```{r}
set.seed(260)

# remove countries with no outcome data available
BR.NoNA.knn <- knn_dataset %>% drop_na(crude_birth_rate_perK)
IM.NoNA.knn <- knn_dataset %>% drop_na(infant_mortality)

# create indices for training set (training:testing = 7:3)
BR.index.train.knn <- 
  createDataPartition(y = BR.NoNA.knn$crude_birth_rate_perK, p = 0.7, list = F)
IM.index.train.knn <- 
  createDataPartition(y = IM.NoNA.knn$infant_mortality, p = 0.7, list = F)

# split the data sets
BR.train.knn <- slice(BR.NoNA.knn, BR.index.train.knn) %>% 
  dplyr::select(-infant_mortality) %>% drop_na()  # 105 rows
BR.test.knn <- slice(BR.NoNA.knn, -BR.index.train.knn) %>% 
  dplyr::select(-infant_mortality) %>% drop_na() # 50 rows
IM.train.knn <- slice(IM.NoNA.knn, IM.index.train.knn) %>% 
  dplyr::select(-crude_birth_rate_perK) %>% drop_na() # 112 rows
IM.test.knn <- slice(IM.NoNA.knn, -IM.index.train.knn) %>% 
  dplyr::select(-crude_birth_rate_perK) %>% drop_na() # 42 rows

# split outcome variable and predictors into two data sets
BR.train.predictors <- BR.train.knn %>% 
  dplyr::select(-c(country,crude_birth_rate_perK))
BR.train.outcome <- BR.train.knn %>% 
  dplyr::select(crude_birth_rate_perK)
BR.test.predictors <- BR.test.knn %>% 
  dplyr::select(-c(country,crude_birth_rate_perK))
BR.test.outcome <- BR.test.knn %>% 
  dplyr::select(crude_birth_rate_perK)
IM.train.predictors <- IM.train.knn %>% 
  dplyr::select(-c(country, infant_mortality))
IM.train.outcome <- IM.train.knn %>% 
  dplyr::select(infant_mortality)
IM.test.predictors <- IM.test.knn %>% 
  dplyr::select(-c(country, infant_mortality))
IM.test.outcome <- IM.test.knn %>% 
  dplyr::select(infant_mortality)
```

#### Run knn regression

```{r}
# run knn regression on birth rate and infant mortality rate
BR.pred.knn.train <- 
  knn.reg(train = BR.train.predictors, 
          y = BR.train.outcome$crude_birth_rate_perK, k = 10) %>% .$pred
IM.pred.knn.train <- 
  knn.reg(train = IM.train.predictors, 
          y = IM.train.outcome$infant_mortality, k = 10) %>% .$pred
BR.pred.knn.test  <- knn.reg(BR.train.predictors, BR.test.predictors, 
                       BR.train.outcome, k = 10) %>% .$pred
IM.pred.knn.test <- knn.reg(IM.train.predictors, IM.test.predictors, 
                       IM.train.outcome, k = 10) %>% .$pred

# create data frames to store predictions and observations
BR.pred.knn.train <- 
  data.frame(country = BR.train.knn$country,
             predicted_BR_train = BR.pred.knn.train,
             observed_BR_train = BR.train.knn$crude_birth_rate_perK)
BR.pred.knn.test <- 
  data.frame(country = BR.test.knn$country,
             predicted_BR_test = BR.pred.knn.test,
             observed_BR_test = BR.test.knn$crude_birth_rate_perK)
IM.pred.knn.train <- 
  data.frame(country = IM.train.knn$country,
             predicted_IM_train = IM.pred.knn.train,
             observed_IM_train = IM.train.knn$infant_mortality)
IM.pred.knn.test <- 
  data.frame(country = IM.test.knn$country,
             predicted_IM_test = IM.pred.knn.test,
             observed_IM_test = IM.test.knn$infant_mortality)

# calculate Pearson coefficients
cor.test(BR.pred.knn.train$predicted_BR_train, BR.pred.knn.train$observed_BR_train,
          method="pearson", conf.level=0.95) # 0.9054893
cor.test(BR.pred.knn.test$predicted_BR_test, BR.pred.knn.test$observed_BR_test,
          method="pearson", conf.level=0.95) # 0.8964598
cor.test(IM.pred.knn.train$predicted_IM_train, IM.pred.knn.train$observed_IM_train,
          method="pearson", conf.level=0.95) # 0.8835293 
cor.test(IM.pred.knn.test$predicted_IM_test, IM.pred.knn.test$observed_IM_test,
          method="pearson", conf.level=0.95) # 0.8550569

# calculate MSEs
mean((BR.pred.knn.train$predicted_BR_train 
      - BR.pred.knn.train$observed_BR_train)^2) # 19.89852
mean((BR.pred.knn.test$predicted_BR_test 
      - BR.pred.knn.test$observed_BR_test)^2) # 18.80149
mean((IM.pred.knn.train$predicted_IM_train 
      - IM.pred.knn.train$observed_IM_train)^2) # 96.95438
mean((IM.pred.knn.test$predicted_IM_test 
      - IM.pred.knn.test$observed_IM_test)^2) # 149.3428
```

